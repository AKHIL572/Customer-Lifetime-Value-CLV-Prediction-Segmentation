import streamlit as st
import numpy as np
import pandas as pd
import joblib

# -----------------------------
# App Config
# -----------------------------
st.set_page_config(
    page_title="Customer Lifetime Value Predictor",
    page_icon="ðŸ“ˆ",
    layout="centered"
)

# -----------------------------
# Load model and features
# -----------------------------


@st.cache_resource
def load_model_assets():
    try:
        model = joblib.load("clv_model.pkl")
        features = joblib.load("clv_features.pkl")
        return model, features
    except FileNotFoundError:
        return None, None


model, feature_names = load_model_assets()

if model is None:
    st.error("ðŸš¨ Model files not found! Please ensure `clv_model.pkl` and `clv_features.pkl` are in the app directory.")
    st.stop()

st.title("ðŸ“Š Customer Lifetime Value (CLV) Prediction")
st.write(
    "Predict **6-month customer value** using historical purchase behavior."
)

# -----------------------------
# Sidebar Inputs
# -----------------------------
st.sidebar.header("Customer Behavior Inputs")

recency = st.sidebar.number_input(
    "Recency (days since last purchase)",
    min_value=0,
    max_value=1000,
    value=30
)

frequency = st.sidebar.number_input(
    "Frequency (number of purchases)",
    min_value=1,
    max_value=500,
    value=5
)

monetary = st.sidebar.number_input(
    "Total Monetary Value (historical spend)",
    min_value=0.0,
    max_value=1_000_000.0,
    value=500.0
)

total_quantity = st.sidebar.number_input(
    "Total Quantity Purchased",
    min_value=1,
    max_value=10_000,
    value=20
)

# -----------------------------
# Prediction
# -----------------------------
if st.sidebar.button("Predict CLV"):
    input_data = pd.DataFrame(
        [[recency, frequency, monetary, total_quantity]],
        columns=feature_names
    )

    # Predict in log scale â†’ convert back
    log_prediction = model.predict(input_data)[0]
    predicted_clv = np.expm1(log_prediction)

    # CLV Segmentation
    if predicted_clv < 1000:
        segment = "Low Value Customer"
        color = "ðŸ”´"
    elif predicted_clv < 5000:
        segment = "Medium Value Customer"
        color = "ðŸŸ "
    else:
        segment = "High Value Customer"
        color = "ðŸŸ¢"

    # -----------------------------
    # Display Results
    # -----------------------------
    st.subheader("ðŸ“Œ Prediction Result")

    st.metric(
        label="Predicted 6-Month CLV",
        value=f"{predicted_clv:,.2f}"
    )

    st.markdown(
        f"### {color} Customer Segment: **{segment}**"
    )

    st.info(
        "CLV is an estimate of future revenue generated by a customer "
        "over the next 6 months based on past behavior."
    )
